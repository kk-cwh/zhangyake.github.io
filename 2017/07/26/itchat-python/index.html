<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="天空之城,zhangykvip@126.com"><title>微信自动回复，所有好友头像合成。。。 · THIS SPACE</title><meta name="description" content="基于itchat 的python微信个人项目 https://github.com/zhangyake/python-itchat目前实现功能

图灵机器人自动回复文本信息 msg
随机回复图片信息 随机图片放在gif目录中
获取所有好友头像 合成为一张大图 
获取所有好友基本信息比如昵称 备注 性"><meta name="keywords" content="Hexo,HTML,CSS,php,Python,Node.js"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.gif" style="width:127px; border-radius: 100px;"><h3 title=""><a href="/">THIS SPACE</a></h3><div class="description"><p>live a good life.</p></div></div></div><ul class="social-links"><li><a href="/atom.xml"><i class="fa fa-rss"></i></a></li><li><a href="http://weibo.com/http://weibo.com/jaakzh"><i class="fa fa-weibo"></i></a></li><li><a href="http://github.com/https://github.com/zhangyake/"><i class="fa fa-github"></i></a></li></ul><div class="footer"><a target="_blank" href="/"><span>Theme by </span></a><a href="https://www.caicai.me"> CaiCai </a><span>&</span><a href="https://github.com/Ben02/hexo-theme-Anatole"> Ben</a><div class="by_farbox"><a href="https://hexo.io/zh-cn/" target="_blank">Proudly published with Hexo&#65281;</a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">首页</a></li><li><a href="/about">关于</a></li><li><a href="/archives">归档</a></li><li><a href="/links">友链</a></li></div><div class="information"><div class="back_btn"><li><a onclick="window.history.go(-1)" class="fa fa-chevron-left"> </a></li></div><div class="avatar"><img src="/images/favicon.png"></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>微信自动回复，所有好友头像合成。。。</a></h3></div><div class="post-content"><p><img src="http://upload-images.jianshu.io/upload_images/337803-ada279ae9405b7dd.gif?imageMogr2/auto-orient/strip" alt="all_friend.gif"></p>
<p>基于<a href="http://itchat.readthedocs.io/zh/latest" target="_blank" rel="external">itchat</a> 的python微信个人项目 <a href="https://github.com/zhangyake/python-itchat" target="_blank" rel="external">https://github.com/zhangyake/python-itchat</a><br><strong>目前实现功能</strong></p>
<ul>
<li>图灵机器人自动回复文本信息 msg</li>
<li>随机回复图片信息 随机图片放在gif目录中</li>
<li>获取所有好友头像 合成为一张大图 </li>
<li>获取所有好友基本信息比如昵称 备注 性别 个性签名等 存放在数据库表中</li>
<li>下载用户发送的图片 附件 录音 视频文件 （<a href="http://itchat.readthedocs.io/zh/latest" target="_blank" rel="external">itchat</a> 存在问题,存在下载失败的情况）</li>
</ul>
<h3 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h3><p><a href="https://github.com/zhangyake/python-itchat" target="_blank" rel="external">项目</a>主要文件是 gif 文件夹 和 weixin.py 下载这两个到本地电脑</p>
<p>1 .  安装<a href="https://www.python.org/downloads/" target="_blank" rel="external">pyhton3</a>最新版 安装时请加入到系统环境变量</p>
<p>2 .  安装一个第三方库——Python Imaging Library </p>
<pre><code>pip install Pillow
</code></pre><p>3 . 安装一个pymysql</p>
<pre><code>pip install pymysql 
</code></pre><p>4 . 安装 <a href="http://itchat.readthedocs.io/zh/latest" target="_blank" rel="external">itchat</a> 库 </p>
<pre><code>pip install itchat
</code></pre><p>5 . 修改 weixin.py 113行key  请自行到<a href="http://www.tuling123.com" target="_blank" rel="external">图灵机器人官网</a>申请key</p>
<p>   网址  <a href="http://www.tuling123.com" target="_blank" rel="external">http://www.tuling123.com</a></p>
<p>6 . 修改数据库配置 weixin.py 167行 改为自己的 执行建表语句</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`friends`</span> (</div><div class="line">   <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</div><div class="line">   <span class="string">`NickName`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'昵称'</span>,</div><div class="line">   <span class="string">`PYInitial`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">   <span class="string">`PYQuanPin`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">   <span class="string">`RemarkName`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'备注'</span>,</div><div class="line">   <span class="string">`RemarkPYInitial`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">   <span class="string">`RemarkPYQuanPin`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">   <span class="string">`Sex`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'性别 1 男 2 女'</span>,</div><div class="line">   <span class="string">`Province`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'省'</span>,</div><div class="line">   <span class="string">`City`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'城市'</span>,</div><div class="line">   <span class="string">`Signature`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'个人签名'</span>,</div><div class="line">   PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</div><div class="line"> ) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> AUTO_INCREMENT=<span class="number">1</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8mb4;</div></pre></td></tr></table></figure>
<p>7 .  到当前目录命令行执行 </p>
<pre><code>python weixin.py
</code></pre><p>   手机微信扫描登录</p>
<h4 id="获取到的用户信息展示"><a href="#获取到的用户信息展示" class="headerlink" title="获取到的用户信息展示"></a>获取到的用户信息展示</h4><p><img src="http://upload-images.jianshu.io/upload_images/337803-7bb831c26dab391d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="9A~XW9$_S@IV]N}WM}WXK8X.png"></p>
<h4 id="自动回复信息展示"><a href="#自动回复信息展示" class="headerlink" title="自动回复信息展示"></a>自动回复信息展示</h4><p><img src="http://upload-images.jianshu.io/upload_images/337803-909745c3652969a7.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p>
<h4 id="直接上代码，写的不好-随意喷"><a href="#直接上代码，写的不好-随意喷" class="headerlink" title="直接上代码，写的不好 随意喷"></a>直接上代码，写的不好 随意喷</h4><figure class="highlight clean"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> os</div><div class="line"><span class="keyword">import</span> time</div><div class="line"><span class="keyword">import</span> requests</div><div class="line"><span class="keyword">import</span> logging</div><div class="line"><span class="keyword">import</span> random</div><div class="line"><span class="keyword">import</span> math</div><div class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</div><div class="line"><span class="keyword">import</span> itchat</div><div class="line"><span class="keyword">from</span> itchat.content <span class="keyword">import</span> *</div><div class="line"><span class="keyword">import</span> pymysql</div><div class="line"></div><div class="line"># 设置自动回复的人字典 valus为 <span class="literal">True</span> 为自动回复，<span class="literal">False</span> 则不自动回复 ,未添加进来的 也不会自动回复</div><div class="line"># key值为好友的昵称的 汉语拼音，如果用户昵称中有其他字符 请登录后 在数据库中查看</div><div class="line">autoDict = &#123;<span class="string">'Caroline'</span>: <span class="literal">True</span>,  <span class="string">'tiankongzhicheng'</span>: <span class="literal">True</span>&#125;</div><div class="line">autoUserNames = &#123;&#125;</div><div class="line"></div><div class="line"></div><div class="line"># 通过下面的方式进行简单配置输出方式与日志级别</div><div class="line">logging.basicConfig(filename=<span class="string">'logger.log'</span>, level=logging.INFO)</div><div class="line"></div><div class="line"># 注册地图 名片 通知 分享信息 回复方法 </div><div class="line">@itchat.msg_register([MAP, CARD, NOTE, SHARING])</div><div class="line">def text_reply(msg):</div><div class="line">    # print(msg) 这里没有自动回复 对信息进行了日志记录</div><div class="line">    <span class="keyword">if</span> autoUserNames.get(msg[<span class="string">'FromUserName'</span>]):</div><div class="line">        info = time.strftime(<span class="string">"%Y-%m-%d %H:%M:%S "</span>, time.localtime()) + \</div><div class="line">            autoUserNames[msg[<span class="string">'FromUserName'</span>]] + <span class="string">" : "</span> + \</div><div class="line">            str(msg[<span class="string">'Text'</span>]) + msg.get(<span class="string">'Url'</span>, <span class="string">''</span>) + <span class="string">"\n"</span></div><div class="line">        <span class="keyword">with</span> open(<span class="string">'msg.info'</span>, <span class="string">'a'</span>, encoding=<span class="string">'utf-8'</span>) <span class="keyword">as</span> f:</div><div class="line">            f.write(info)</div><div class="line">        # logging.info(info) </div><div class="line"></div><div class="line"></div><div class="line"># 注册文本信息 回复方法</div><div class="line">@itchat.msg_register(TEXT)</div><div class="line">def text_reply(msg):</div><div class="line">    <span class="keyword">if</span> autoUserNames.get(msg[<span class="string">'FromUserName'</span>]):</div><div class="line">        info = time.strftime(<span class="string">"%Y-%m-%d %H:%M:%S "</span>, time.localtime()) + \</div><div class="line">            autoUserNames[msg[<span class="string">'FromUserName'</span>]] + <span class="string">" : "</span> + \</div><div class="line">            str(msg[<span class="string">'Text'</span>]) + msg.get(<span class="string">'Url'</span>, <span class="string">''</span>) + <span class="string">"\n"</span></div><div class="line">        #对信息进行了日志记录 写入了文本</div><div class="line">        <span class="keyword">with</span> open(<span class="string">'msg.info'</span>, <span class="string">'a'</span>, encoding=<span class="string">'utf-8'</span>) <span class="keyword">as</span> f:</div><div class="line">            f.write(info)</div><div class="line">        text = request_robot(info=msg[<span class="string">'Text'</span>], userid=msg[<span class="string">'FromUserName'</span>])</div><div class="line">        itchat.send(text, msg[<span class="string">'FromUserName'</span>])</div><div class="line"></div><div class="line"></div><div class="line"># 在注册时增加isGroupChat=<span class="literal">True</span>将判定为群聊回复</div><div class="line">@itchat.msg_register(TEXT, isGroupChat=<span class="literal">True</span>)</div><div class="line">def groupchat_reply(msg):</div><div class="line">    <span class="keyword">if</span> not msg[<span class="string">'IsAt'</span>] :</div><div class="line">        # 请求图灵机器人 获取要回复的内容</div><div class="line">        text = request_robot(info=msg[<span class="string">'Text'</span>], userid=msg[<span class="string">'FromUserName'</span>])</div><div class="line">        # 发送到群里</div><div class="line">        itchat.send(text, msg[<span class="string">'FromUserName'</span>])</div><div class="line"></div><div class="line"></div><div class="line"># 在注册 图片 附件 语音 视频 信息 下载方法</div><div class="line">@itchat.msg_register([PICTURE, RECORDING, ATTACHMENT, VIDEO])</div><div class="line">def download_files(msg):</div><div class="line">    msg[<span class="string">'Text'</span>](msg[<span class="string">'FileName'</span>]) #下载文件</div><div class="line">    <span class="keyword">if</span> autoUserNames.get(msg[<span class="string">'FromUserName'</span>]):</div><div class="line">        fileName = os.path.join(<span class="string">'gif'</span>, <span class="string">'&#123;&#125;.gif'</span>.format(random.randint(<span class="number">1</span>, <span class="number">25</span>)))</div><div class="line">        file = <span class="string">'@&#123;&#125;@&#123;&#125;'</span>.format(&#123;<span class="string">'Picture'</span>: <span class="string">'img'</span>, <span class="string">'Video'</span>: <span class="string">'vid'</span>&#125;.get(</div><div class="line">            msg[<span class="string">'Type'</span>], <span class="string">'fil'</span>), fileName)</div><div class="line">        <span class="keyword">if</span> msg[<span class="string">'Type'</span>] == <span class="string">'Picture'</span>:</div><div class="line">            itchat.send(file, msg[<span class="string">'FromUserName'</span>])</div><div class="line"></div><div class="line"></div><div class="line"># 拼接合成好友头像</div><div class="line">def make_all_friends_img(image_list, width=<span class="number">120</span>, height=<span class="number">120</span>, save_name=<span class="string">'all_friend.jpg'</span>):</div><div class="line">    images_count = len(image_list)</div><div class="line">    n = int(math.ceil(pow(images_count, <span class="number">0.5</span>)))</div><div class="line">    toImage = Image.new(<span class="string">'RGBA'</span>, (width * n, height * n), (<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>))</div><div class="line">    for y <span class="keyword">in</span> range(<span class="number">0</span>, n):</div><div class="line">        for x <span class="keyword">in</span> range(<span class="number">0</span>, n):</div><div class="line">            print(x * width, y * height)</div><div class="line">            try:</div><div class="line">                fromImage = Image.open(image_list.pop())</div><div class="line">                fromImage = fromImage.resize((width, height), Image.ANTIALIAS)</div><div class="line">                toImage.paste(fromImage, (x * width, y * height))</div><div class="line">            except Exception <span class="keyword">as</span> e:</div><div class="line">                print(<span class="string">'某头像图片有误'</span>)</div><div class="line">            <span class="keyword">if</span> len(image_list) == <span class="number">0</span>:</div><div class="line">                toImage.save(save_name)</div><div class="line">                print(<span class="string">'合成图像success'</span>)</div><div class="line">                return</div><div class="line"></div><div class="line"></div><div class="line"># 获取所以好友头像</div><div class="line">def get_all_friends_img(picDir=<span class="string">'friends'</span>):</div><div class="line">    images = []</div><div class="line">    <span class="keyword">if</span> not os.path.isdir(picDir):</div><div class="line">        os.makedirs(picDir)</div><div class="line">    for i, friend <span class="keyword">in</span> enumerate(itchat.get_friends()):</div><div class="line">        itchat.get_head_img(userName=friend[<span class="string">'UserName'</span>], picDir=os.path.join(picDir, str(i)+<span class="string">'.png'</span>))</div><div class="line">        images.append(os.path.join(picDir, str(i)+<span class="string">'.png'</span>))</div><div class="line">    return images </div><div class="line"></div><div class="line">codes_map = &#123;</div><div class="line">    <span class="number">100000</span>: <span class="literal">True</span>,  # <span class="string">'文本类'</span></div><div class="line">    <span class="number">200000</span>: <span class="literal">True</span>,  # <span class="string">'链接类'</span></div><div class="line">    <span class="number">302000</span>: <span class="literal">True</span>,  # <span class="string">'新闻类'</span></div><div class="line">    <span class="number">308000</span>: <span class="literal">True</span>,  # <span class="string">'菜谱类'</span></div><div class="line">    <span class="number">40001</span>: <span class="literal">True</span>,  # <span class="string">'参数 key 错误'</span></div><div class="line">    <span class="number">40002</span>: <span class="literal">True</span>,  # <span class="string">'请求内容 info 为空'</span></div><div class="line">    <span class="number">40004</span>: <span class="literal">True</span>,  # <span class="string">'当天请求次数已使用完'</span></div><div class="line">    <span class="number">40007</span>: <span class="literal">True</span>,  # <span class="string">'数据格式异常'</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"># 向图灵机器人发送请求 获取结果</div><div class="line">def request_robot(info=<span class="string">'hello'</span>, userid=<span class="string">'123456'</span>, url=<span class="string">'http://www.tuling123.com/openapi/api'</span>, key=<span class="string">'d0ee53f65c46a4206a5b049f1eda674c8'</span>):</div><div class="line">    res = requests.post(url, json=&#123;<span class="string">'key'</span>: key, <span class="string">'userid'</span>: userid, <span class="string">'info'</span>: info&#125;)</div><div class="line">    <span class="keyword">if</span> res.status_code == <span class="number">200</span>:</div><div class="line">        data = res.json()</div><div class="line">        return response_handle(**data)</div><div class="line">    else:</div><div class="line">        return <span class="string">'抱歉,稍等。。。'</span></div><div class="line"></div><div class="line"></div><div class="line"># 处理机器人返回的数据</div><div class="line">def response_handle(**kw):</div><div class="line">    <span class="keyword">code</span> = kw.get(<span class="string">'code'</span>, <span class="number">40004</span>)</div><div class="line">    res_str = <span class="string">''</span></div><div class="line">    <span class="keyword">if</span> <span class="keyword">code</span> == <span class="number">100000</span> or <span class="keyword">code</span> == <span class="number">200000</span>:</div><div class="line">        res_str = kw.get(<span class="string">'text'</span>, <span class="string">''</span>) + kw.get(<span class="string">'url'</span>, <span class="string">''</span>)</div><div class="line">    elif <span class="keyword">code</span> == <span class="number">302000</span>:</div><div class="line">        news = kw.get(<span class="string">'list'</span>)</div><div class="line">        <span class="keyword">if</span> isinstance(news, Iterable):</div><div class="line">            for nw <span class="keyword">in</span> news:</div><div class="line">                res_str += (nw.get(<span class="string">'article'</span>, <span class="string">''</span>) + <span class="string">'\n'</span> +</div><div class="line">                            nw.get(<span class="string">'detailurl'</span>, <span class="string">''</span>) + <span class="string">'\n'</span>)</div><div class="line">    elif <span class="keyword">code</span> == <span class="number">308000</span>:</div><div class="line">        news = kw.get(<span class="string">'list'</span>)</div><div class="line">        <span class="keyword">if</span> isinstance(news, Iterable):</div><div class="line">            for nw <span class="keyword">in</span> news:</div><div class="line">                res_str += (nw.get(<span class="string">'name'</span>, <span class="string">''</span>) + <span class="string">'\n'</span> +</div><div class="line">                            nw.get(<span class="string">'detailurl'</span>, <span class="string">''</span>) + <span class="string">'\n'</span>)</div><div class="line">    else:</div><div class="line">        res_str = kw.get(<span class="string">'text'</span>, <span class="string">''</span>)</div><div class="line"></div><div class="line">    return res_str</div><div class="line"></div><div class="line"></div><div class="line">def get_rooms_info():</div><div class="line">    for i, friend <span class="keyword">in</span> enumerate(itchat.get_chatrooms()):</div><div class="line">        logging.info(str(friend))</div><div class="line"></div><div class="line"># 添加用户到数据库 这里(host=<span class="string">'192.168.10.10'</span>,user=<span class="string">'homestead'</span>,password=<span class="string">'secret'</span>,db=<span class="string">'test'</span>,charset=<span class="string">'utf8mb4'</span>) 请更改为自己的数据库账户密码</div><div class="line"># 建表语句</div><div class="line">#  CREATE TABLE `friends` (</div><div class="line">#   `id` int(<span class="number">11</span>) NOT NULL AUTO_INCREMENT,</div><div class="line">#   `NickName` varchar(<span class="number">255</span>) DEFAULT NULL COMMENT <span class="string">'昵称'</span>,</div><div class="line">#   `PYInitial` varchar(<span class="number">255</span>) DEFAULT NULL,</div><div class="line">#   `PYQuanPin` varchar(<span class="number">255</span>) DEFAULT NULL,</div><div class="line">#   `RemarkName` varchar(<span class="number">255</span>) DEFAULT NULL COMMENT <span class="string">'备注'</span>,</div><div class="line">#   `RemarkPYInitial` varchar(<span class="number">255</span>) DEFAULT NULL,</div><div class="line">#   `RemarkPYQuanPin` varchar(<span class="number">255</span>) DEFAULT NULL,</div><div class="line">#   `Sex` varchar(<span class="number">255</span>) DEFAULT NULL COMMENT <span class="string">'性别 1 男 2 女'</span>,</div><div class="line">#   `Province` varchar(<span class="number">255</span>) DEFAULT NULL COMMENT <span class="string">'省'</span>,</div><div class="line">#   `City` varchar(<span class="number">255</span>) DEFAULT NULL COMMENT <span class="string">'城市'</span>,</div><div class="line">#   `Signature` varchar(<span class="number">255</span>) DEFAULT NULL COMMENT <span class="string">'个人签名'</span>,</div><div class="line">#   PRIMARY KEY (`id`)</div><div class="line"># ) ENGINE=InnoDB AUTO_INCREMENT=<span class="number">1</span> DEFAULT CHARSET=utf8mb4;</div><div class="line">def add_to_db(**kw):</div><div class="line">    connection = pymysql.connect(host=<span class="string">'192.168.10.10'</span>,user=<span class="string">'homestead'</span>,password=<span class="string">'secret'</span>,db=<span class="string">'test'</span>,charset=<span class="string">'utf8mb4'</span>)</div><div class="line">    try:</div><div class="line">        <span class="keyword">with</span> connection.cursor() <span class="keyword">as</span> cursor:</div><div class="line">            sql = <span class="string">"INSERT INTO `friends` ( `NickName`, `PYInitial`, `PYQuanPin`, `RemarkName`, `RemarkPYInitial`, `RemarkPYQuanPin` , `Sex`, `Province`, `City`, `Signature`) VALUES (%s, %s, %s, %s, %s,%s, %s, %s, %s, %s)"</span></div><div class="line">            cursor.execute(sql,(kw.get(<span class="string">'NickName'</span>),kw.get(<span class="string">'PYInitial'</span>),kw.get(<span class="string">'PYQuanPin'</span>),kw.get(<span class="string">'RemarkName'</span>,<span class="string">'无'</span>),kw.get(<span class="string">'RemarkPYInitial'</span>),kw.get(<span class="string">'RemarkPYQuanPin'</span>),kw.get(<span class="string">'Sex'</span>),kw.get(<span class="string">'Province'</span>),kw.get(<span class="string">'City'</span>),kw.get(<span class="string">'Signature'</span>)))</div><div class="line">            connection.commit()</div><div class="line">    except Exception <span class="keyword">as</span> e:</div><div class="line">        print(e)</div><div class="line">    finally:</div><div class="line">        connection.close()</div><div class="line"></div><div class="line">def get_auto_friends_username():</div><div class="line">    for i, friend <span class="keyword">in</span> enumerate(itchat.get_friends()):</div><div class="line">        <span class="keyword">if</span> autoDict.get(friend[<span class="string">'PYQuanPin'</span>]):</div><div class="line">            autoUserNames[friend[<span class="string">'UserName'</span>]] = friend[<span class="string">'NickName'</span>]</div><div class="line">        else:</div><div class="line">            pass</div><div class="line">            # <span class="keyword">with</span> open(<span class="string">'friends_base.info'</span>, <span class="string">'a'</span>, encoding=<span class="string">'utf-8'</span>) <span class="keyword">as</span> f:</div><div class="line">            #     f.write(<span class="string">'昵称:'</span> + friend[<span class="string">'NickName'</span>] +  <span class="string">'  备注: '</span> + (friend[<span class="string">'RemarkName'</span>] == <span class="string">''</span> ? <span class="string">'无'</span>: friend[<span class="string">'RemarkName'</span>]) + <span class="string">' 性别:'</span> + str(friend[<span class="string">'Sex'</span>]) + <span class="string">' 区域: '</span>+ friend[<span class="string">'Province'</span>] + friend[<span class="string">'City'</span>] + <span class="string">' 签名:'</span> +friend[<span class="string">'Signature'</span>] +  <span class="string">'\n'</span>)</div><div class="line">        add_to_db(**friend) # 添加用户信息到MySQL数据库friends表中</div><div class="line">    print(<span class="string">'如下的用户发送text消息，系统将自动回复：'</span>)</div><div class="line">    for user <span class="keyword">in</span> autoUserNames.values():</div><div class="line">        print(<span class="string">'---------------------------------------------'</span>)</div><div class="line">        print(<span class="string">'--------------&#123;&#125;'</span>.format(user))</div><div class="line">    images = get_all_friends_img()</div><div class="line">    # images.reverse()</div><div class="line">    make_all_friends_img(images)</div><div class="line">    itchat.send(<span class="string">'@img@&#123;&#125;'</span>.format(<span class="string">'all_friend.jpg'</span>))#登录时将会把所有好友头像合照发送给登录账户</div><div class="line"></div><div class="line"></div><div class="line">itchat.auto_login(loginCallback=get_auto_friends_username, enableCmdQR=<span class="literal">False</span>)</div><div class="line">itchat.run()</div></pre></td></tr></table></figure></div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2017-07-26</span><i class="fa fa-tag"></i></div></div></div></div><div class="share"><div class="evernote"><a href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank" class="fa fa-bookmark"></a></div><div class="weibo"><a href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));" class="fa fa-weibo"></a></div><div class="twitter"><a href="http://twitter.com/home?status=,http://zhangyake.github.io/2017/07/26/itchat-python/,THIS SPACE,微信自动回复，所有好友头像合成。。。,;" class="fa fa-twitter"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a role="navigation" href="/2017/08/04/vue-page/" title="vue 分页插件" class="btn">上一篇</a></li><li class="next pagbuttons"><a role="navigation" href="/2017/01/08/phpdebug/" title="PHP调试环境搭建(xdebug+PHPstorm +Chrome插件 Xdbug helper)" class="btn">下一篇</a></li></ul></div><a id="comments"></a><div id="cloud-tie-wrapper" class="cloud-tie-wrapper"></div><script src="https://img1.cache.netease.com/f2e/tie/yun/sdk/loader.js"></script><script>var cloudTieConfig = { url: document.location.href, sourceId: '2017/07/26/itchat-python/', productKey: 'zhangykvip@126.com', target: 'cloud-tie-wrapper' };var yunManualLoad = true;Tie.loader("aHR0cHM6Ly9hcGkuZ2VudGllLjE2My5jb20vcGMvbGl2ZXNjcmlwdC5odG1s", true);</script></div></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script></body></html>